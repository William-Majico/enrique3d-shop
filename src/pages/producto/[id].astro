---
// 1. IMPORTANTE: Activamos modo servidor
export const prerender = false;

import Layout from "../../layouts/Layout.astro";
import products from "../../data/products.json";

// 2. LÓGICA DE SERVIDOR
const { id } = Astro.params;
const product = products.find((p) => p.id === id);

// 3. Si el producto no existe, redirigimos
if (!product) {
  return Astro.redirect("/");
}

// Funciones auxiliares
const isVideo = (filename: string) => filename.toLowerCase().endsWith(".mp4");
const posterImage = product.images.find((img) => !isVideo(img)) || "";

// Función para calcular porcentaje de descuento
const getDiscountPercent = (price, oldPrice) => {
    if (!oldPrice || oldPrice <= price) return 0;
    return Math.round(((oldPrice - price) / oldPrice) * 100);
};

const discountPercent = getDiscountPercent(product.price, product.oldPrice);

// --- LÓGICA DE RELACIONADOS ---
const otherProducts = products.filter((p) => p.id !== product.id);
const relatedProducts = otherProducts
  .sort(() => 0.5 - Math.random())
  .slice(0, 3);
---

<Layout
  title={`${product.title} | Enrique 3D`}
  description={product.description}
  image={product.images[0]}
>
  
  <div class="fixed inset-0 -z-10 pointer-events-none bg-warm-cream dark:bg-[#0f1117]">
    <div class="absolute inset-0" style="background-image: radial-gradient(circle at 1px 1px, rgba(128, 128, 128, 0.1) 1px, transparent 0); background-size: 40px 40px;"></div>
  </div>

  <main class="pt-28 md:pt-36 pb-16 md:pb-24 px-4 md:px-8">
    <div class="max-w-7xl mx-auto">
      
      <nav class="flex items-center gap-2 text-sm text-gray-500 dark:text-gray-400 mb-8">
        <a href="/" class="hover:text-orange-500 transition-colors">Inicio</a>
        <i class="ri-arrow-right-s-line text-gray-300 dark:text-gray-600"></i>
        <span class="text-gray-900 dark:text-white font-medium truncate">{product.title}</span>
      </nav>
      
      <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 md:gap-12">
        
        {/* COLUMNA IZQUIERDA: GALERÍA */}
        <div class="lg:col-span-7 w-full">
          <div class="w-full flex flex-col gap-4 sticky top-24">
            
            <div
              id="main-viewport"
              class="group relative bg-white dark:bg-[#1a1d26] rounded-2xl shadow-sm border border-gray-200 dark:border-gray-800 aspect-video w-full overflow-hidden"
            >
              {/* Badge Principal */}
              {product.onSale && (
                <span class="absolute top-4 left-4 z-20 bg-orange-600 text-white text-xs font-bold px-3 py-1.5 rounded uppercase tracking-wider shadow-lg">
                   {product.badge?.text || `-${discountPercent}% OFF`}
                </span>
              )}

              <div
                id="carousel-container"
                class="flex w-full h-full overflow-x-auto snap-x snap-mandatory scrollbar-hide"
                style="scroll-behavior: smooth;"
              >
                {
                  product.images.map((media, index) => (
                    <div
                      class="w-full h-full flex-shrink-0 snap-center flex items-center justify-center relative bg-gray-50 dark:bg-black/20"
                      data-index={index}
                    >
                      {isVideo(media) ? (
                        <video
                          src={media}
                          preload="none"
                          poster={posterImage}
                          playsinline
                          muted
                          loop
                          class="carousel-video w-full h-full object-contain"
                        />
                      ) : (
                        <img
                          src={media}
                          alt={`Vista ${index + 1} de ${product.title}`}
                          loading="eager"
                          class="max-w-full max-h-full object-contain"
                        />
                      )}
                    </div>
                  ))
                }
              </div>

              {/* Botones Navegación */}
              <button
                id="prev-btn"
                class="hidden md:flex absolute left-4 top-1/2 -translate-y-1/2 z-30 w-10 h-10 items-center justify-center rounded-full bg-white/80 dark:bg-black/50 text-gray-800 dark:text-white backdrop-blur-sm border border-gray-200 dark:border-gray-700 hover:scale-110 transition-transform hover:bg-white hover:text-orange-500"
              >
                <i class="ri-arrow-left-s-line text-xl"></i>
              </button>
              <button
                id="next-btn"
                class="hidden md:flex absolute right-4 top-1/2 -translate-y-1/2 z-30 w-10 h-10 items-center justify-center rounded-full bg-white/80 dark:bg-black/50 text-gray-800 dark:text-white backdrop-blur-sm border border-gray-200 dark:border-gray-700 hover:scale-110 transition-transform hover:bg-white hover:text-orange-500"
              >
                <i class="ri-arrow-right-s-line text-xl"></i>
              </button>

              {/* Indicador Móvil */}
              <div class="absolute bottom-4 left-1/2 -translate-x-1/2 flex gap-2 md:hidden z-30 pointer-events-none p-1.5 rounded-full bg-black/30 backdrop-blur-md">
                {
                  product.images.map((_, index) => (
                    <div class={`dot h-1.5 rounded-full transition-all duration-300 ${index === 0 ? "bg-white w-6" : "bg-white/50 w-1.5"}`} />
                  ))
                }
              </div>
            </div>

            {/* MINIATURAS */}
            <div class="flex gap-3 overflow-x-auto pb-2 scrollbar-hide snap-x">
              {
                product.images.map((media, index) => (
                  <button
                    class={`thumbnail-btn relative flex-shrink-0 w-20 h-20 rounded-xl overflow-hidden border-2 transition-all cursor-pointer snap-start group ${index === 0 ? "border-orange-500 ring-2 ring-orange-500/20" : "border-transparent opacity-70 hover:opacity-100"}`}
                    data-index={index}
                  >
                    {isVideo(media) ? (
                      <div class="w-full h-full relative overflow-hidden">
                        <img 
                            src={posterImage} 
                            class="w-full h-full object-cover opacity-60 blur-[1px] group-hover:blur-0 group-hover:opacity-80 transition-all" 
                        />
                        <div class="absolute inset-0 flex items-center justify-center">
                            <div class="w-8 h-8 rounded-full bg-black/40 flex items-center justify-center backdrop-blur-sm border border-white/20">
                                <i class="ri-play-fill text-white text-sm"></i>
                            </div>
                        </div>
                      </div>
                    ) : (
                      <img
                        class="w-full h-full object-cover"
                        src={media}
                        loading="lazy"
                      />
                    )}
                  </button>
                ))
              }
            </div>
          </div>
        </div>

        {/* COLUMNA DERECHA: INFO Y COMPRA */}
        <div class="lg:col-span-5 w-full">
          <div class="lg:sticky lg:top-32 h-fit flex flex-col gap-8">
            
            {/* Header */}
            <div>
              <div class="flex items-center gap-2 mb-3">
                 <span class="px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider bg-gray-200 dark:bg-gray-800 text-gray-600 dark:text-gray-400">
                    Asset 3D
                 </span>
                 {product.onSale && (
                    <span class="px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400">
                        MONEDA - USD
                    </span>
                 )}
              </div>
              
              <h1 class="text-3xl md:text-4xl font-extrabold text-gray-900 dark:text-white tracking-tight mb-2">
                {product.title}
              </h1>
              
              <div class="flex items-baseline gap-3 mt-4">
                <p class="text-4xl font-bold text-gray-900 dark:text-white">
                  ${product.price}
                </p>
                {product.onSale && (
                  <p class="text-lg text-gray-400 line-through decoration-1">
                    ${product.oldPrice}
                  </p>
                )}
              </div>
            </div>

            <div class="h-px w-full bg-gray-200 dark:border-gray-800"></div>

            <div class="prose prose-sm prose-gray dark:prose-invert">
              <p class="text-gray-600 dark:text-gray-300 leading-relaxed text-base">
                {product.description}
              </p>
            </div>

            {/* Especificaciones */}
            <div>
              <h3 class="text-xs font-bold text-gray-900 dark:text-white uppercase tracking-widest mb-4 flex items-center gap-2">
                <i class="ri-cpu-line"></i> Especificaciones
              </h3>
              <div class="grid grid-cols-2 gap-3">
                {product.specs && Object.entries(product.specs).map(([key, value]) => (
                  <div class="bg-white dark:bg-[#1a1d26] border border-gray-200 dark:border-gray-800 p-3 rounded-lg flex flex-col">
                    <span class="text-[10px] text-gray-400 uppercase font-semibold mb-1">
                      {key.replace(/([A-Z])/g, " $1").trim()}
                    </span>
                    <span class="text-sm font-medium text-gray-900 dark:text-white truncate">
                      {value}
                    </span>
                  </div>
                ))}
              </div>
            </div>

            {/* Botones de Acción */}
            <div class="flex flex-col gap-3 mt-2">
              
              {/* Botón Principal */}
              <button
                class="w-full py-4 bg-gray-900 dark:bg-white text-white dark:text-gray-900 font-bold rounded-xl hover:bg-orange-600 dark:hover:bg-gray-200 transition-all shadow-lg shadow-gray-200/50 dark:shadow-none flex items-center justify-center gap-2 group active:scale-[0.98]"
                onclick={`window.comprar('${product.id}', this)`}
              >
                <i class="ri-shopping-bag-3-fill text-lg group-hover:animate-bounce"></i>
                <span>Comprar Ahora</span>
              </button>

              {/* SEPARADOR CON TEXTO */}
              <div class="relative flex py-2 items-center">
                 <div class="flex-grow border-t border-gray-200 dark:border-gray-700"></div>
                 <span class="flex-shrink-0 mx-4 text-[10px] text-gray-400 uppercase tracking-widest font-bold">
                    ¿Tienes dudas?
                 </span>
                 <div class="flex-grow border-t border-gray-200 dark:border-gray-700"></div>
              </div>

              {/* Botones de Soporte DIVIDIDOS */}
              <div class="flex gap-3">
                <a
                  href="mailto:enrique3d.studio@gmail.com"
                  class="flex-1 py-3 bg-gray-100 dark:bg-gray-800 text-gray-600 dark:text-gray-300 font-semibold rounded-xl hover:bg-gray-200 dark:hover:bg-gray-700 transition-all border border-gray-200 dark:border-gray-700 flex items-center justify-center gap-2"
                >
                  <i class="ri-mail-send-line text-lg"></i>
                  <span>Email</span>
                </a>

                <a
                  href={product.discordLink || "https://discord.gg/EbEtTsyrC5"}
                  target="_blank"
                  class="flex-1 py-3 bg-[#5865F2]/10 text-[#5865F2] font-semibold rounded-xl hover:bg-[#5865F2] hover:text-white transition-all border border-[#5865F2]/20 flex items-center justify-center gap-2"
                >
                  <i class="ri-discord-line text-lg"></i>
                  <span>Discord</span>
                </a>
              </div>
            </div>

            <div class="flex items-center justify-center gap-6 pt-4 border-t border-gray-100 dark:border-gray-800">
                <div class="flex items-center gap-2 text-xs text-gray-500 dark:text-gray-400">
                    <i class="ri-shield-check-line text-green-500"></i> Pagos Seguros
                </div>
                <div class="flex items-center gap-2 text-xs text-gray-500 dark:text-gray-400">
                    <i class="ri-flashlight-line text-orange-500"></i> Entrega Inmediata
                </div>
            </div>

          </div>
        </div>
      </div>

      {/* SECCIÓN RELACIONADOS */}
      <div class="mt-24 border-t border-gray-200 dark:border-gray-800 pt-16">
        <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-8 flex items-center gap-2">
          <i class="ri-layout-grid-fill text-orange-500"></i>
          Completa tu colección
        </h2>

        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
          {
            relatedProducts.map((related) => (
              <a
                href={`/producto/${related.id}`}
                class="group block bg-white dark:bg-[#1a1d26] border border-gray-200 dark:border-gray-800 rounded-xl overflow-hidden hover:border-orange-500/50 dark:hover:border-orange-500/50 transition-all duration-300 hover:shadow-xl"
              >
                <div class="aspect-video w-full overflow-hidden bg-gray-100 dark:bg-gray-900 border-b border-gray-100 dark:border-gray-800 relative">
                  <img
                    src={related.images[0]}
                    alt={related.title}
                    loading="lazy"
                    class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500"
                  />
                  {related.onSale && (
                      <span class={`absolute top-2 right-2 ${related.badge?.bgColor || "bg-orange-600"} text-white text-[10px] font-bold px-2 py-1 rounded uppercase tracking-wider`}>
                        {related.badge?.text || "OFERTA"}
                      </span>
                  )}
                </div>
                
                <div class="p-5">
                  <h3 class="font-bold text-gray-900 dark:text-white group-hover:text-orange-500 transition-colors truncate text-lg">
                    {related.title}
                  </h3>
                  
                  <div class="flex justify-between items-center mt-3">
                    <div class="flex flex-col">
                        <span class="text-[10px] text-gray-400 uppercase font-semibold">Precio</span>
                        <div class="flex items-baseline gap-2">
                            <span class="text-base font-bold text-gray-900 dark:text-white">
                                ${related.price}
                            </span>
                            {related.onSale && (
                                <span class="text-xs text-gray-400 line-through decoration-orange-500/50">
                                    ${related.oldPrice}
                                </span>
                            )}
                        </div>
                    </div>
                    
                    <div class="w-8 h-8 rounded-full bg-gray-100 dark:bg-gray-800 flex items-center justify-center text-gray-400 group-hover:bg-orange-500 group-hover:text-white transition-all">
                        <i class="ri-arrow-right-line"></i>
                    </div>
                  </div>
                </div>
              </a>
            ))
          }
        </div>
      </div>
    </div>
  </main>
</Layout>

<script is:inline>
  // --- LÓGICA DE CARRUSEL ---
  const container = document.getElementById("carousel-container");
  const prevBtn = document.getElementById("prev-btn");
  const nextBtn = document.getElementById("next-btn");
  const dots = document.querySelectorAll(".dot");
  const thumbs = document.querySelectorAll(".thumbnail-btn");
  const videos = container?.querySelectorAll(".carousel-video") || [];
  let currentIndex = 0;
  const totalSlides = thumbs.length;

  const updateState = (index) => {
    currentIndex = index;
    
    // Puntos
    dots.forEach((dot, i) => {
      if (i === index) {
        dot.classList.remove("bg-white/50", "w-1.5");
        dot.classList.add("bg-white", "w-6");
      } else {
        dot.classList.add("bg-white/50", "w-1.5");
        dot.classList.remove("bg-white", "w-6");
      }
    });

    // Miniaturas
    thumbs.forEach((thumb, i) => {
      if (i === index) {
        thumb.classList.remove("border-transparent", "opacity-70");
        thumb.classList.add("border-orange-500", "ring-2", "ring-orange-500/20", "opacity-100");
        thumb.scrollIntoView({ behavior: "smooth", block: "nearest", inline: "center" });
      } else {
        thumb.classList.add("border-transparent", "opacity-70");
        thumb.classList.remove("border-orange-500", "ring-2", "ring-orange-500/20", "opacity-100");
      }
    });

    // Videos
    if (videos.length > 0) {
        videos.forEach((video) => {
        const slideParent = video.closest("div");
        const slideIndex = parseInt(slideParent.getAttribute("data-index"));
        if (slideIndex === index) {
            video.play().catch(() => {});
            video.setAttribute("controls", "true");
        } else {
            video.pause();
            video.currentTime = 0;
            video.removeAttribute("controls");
        }
        });
    }
  };

  if (container) {
    container.addEventListener("scroll", () => {
        const slideWidth = container.offsetWidth;
        const newIndex = Math.round(container.scrollLeft / slideWidth);
        if (newIndex !== currentIndex && newIndex >= 0 && newIndex < totalSlides) {
            updateState(newIndex);
        }
    });
  }

  const manualScroll = (index) => {
    if(!container) return;
    const slideWidth = container.offsetWidth;
    container.scrollTo({ left: index * slideWidth, behavior: "smooth" });
  };

  if (nextBtn) nextBtn.addEventListener("click", () => {
    manualScroll((currentIndex + 1) % totalSlides);
  });
  
  if (prevBtn) prevBtn.addEventListener("click", () => {
    manualScroll((currentIndex - 1 + totalSlides) % totalSlides);
  });

  thumbs.forEach((thumb) => {
    thumb.addEventListener("click", () => {
      const idx = parseInt(thumb.getAttribute("data-index"));
      manualScroll(idx);
    });
  });

  setTimeout(() => updateState(0), 100);

  // --- LÓGICA DE PAGO ---
  window.comprar = async (id, btn) => {
    const originalContent = btn.innerHTML;
    btn.innerHTML = `<i class="ri-loader-4-line animate-spin text-xl"></i><span>Procesando...</span>`;
    btn.disabled = true;
    btn.classList.add('opacity-75', 'cursor-not-allowed');
    
    try {
      const respuesta = await fetch("/api/crear-pago", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ productId: id }),
      });

      const rawText = await respuesta.text();
      let datos;
      try {
          datos = JSON.parse(rawText);
      } catch (e) {
          throw new Error("Error del servidor");
      }

      if (respuesta.ok && datos.url) {
        window.location.href = datos.url;
      } else {
        throw new Error(datos.error || "No se pudo iniciar el pago");
      }
    } catch (error) {
      console.error(error);
      alert("Error: " + error.message);
      btn.innerHTML = originalContent;
      btn.disabled = false;
      btn.classList.remove('opacity-75', 'cursor-not-allowed');
    }
  };
</script>

<style>
  .scrollbar-hide::-webkit-scrollbar { display: none; }
  .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
</style>